"use strict";(self.webpackChunkterraform_controller_docs=self.webpackChunkterraform_controller_docs||[]).push([[3323],{3905:function(e,t,r){r.d(t,{Zo:function(){return u},kt:function(){return m}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),c=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},u=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},f=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),f=c(r),m=a,d=f["".concat(s,".").concat(m)]||f[m]||p[m]||i;return r?n.createElement(d,o(o({ref:t},u),{},{components:r})):n.createElement(d,o({ref:t},u))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=f;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var c=2;c<i;c++)o[c]=r[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}f.displayName="MDXCreateElement"},6499:function(e,t,r){r.r(t),r.d(t,{assets:function(){return u},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return p}});var n=r(7462),a=r(3366),i=(r(7294),r(3905)),o=["components"],l={sidebar_position:4},s="Drift Detection",c={unversionedId:"admin/drift",id:"admin/drift",title:"Drift Detection",description:"Drift detection periodically runs a terraform plan on a Configuration, ensuring the expected state (terraform state) and the actual cloud resources are in sync. Currently Configurations must opt in for drift detection via their spec;",source:"@site/docs/terranetes-controller/admin/drift.md",sourceDirName:"admin",slug:"/admin/drift",permalink:"/terranetes-controller/admin/drift",draft:!1,editUrl:"https://github.com/appvia/terranetes/tree/master/docs/terranetes-controller/admin/drift.md",tags:[],version:"current",lastUpdatedBy:"Kashif Saadat",lastUpdatedAt:1661415599,formattedLastUpdatedAt:"8/25/2022",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Terraform State",permalink:"/terranetes-controller/admin/state"},next:{title:"Observability",permalink:"/terranetes-controller/category/observability"}},u={},p=[{value:"Tuning Drift Detection",id:"tuning-drift-detection",level:2},{value:"Drift Intervals",id:"drift-intervals",level:3},{value:"Drift Threshold",id:"drift-threshold",level:3},{value:"Selection Process",id:"selection-process",level:3}],f={toc:p};function m(e){var t=e.components,r=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,n.Z)({},f,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"drift-detection"},"Drift Detection"),(0,i.kt)("p",null,"Drift detection periodically runs a terraform plan on a ",(0,i.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration"),", ensuring the expected state ",(0,i.kt)("em",{parentName:"p"},"(terraform state)")," and the actual cloud resources are in sync. Currently ",(0,i.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configurations")," must opt in for drift detection via their spec;"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: terraform.appvia.io/v1alpha1\nkind: Configuration\nmetadata:\n  name: bucket\nspec:\n  module: https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.1.0\n  providerRef:\n    namespace: terraform-system\n    name: aws\n  # You can enable drift protection as so\n  enableDriftDetection: true\n")),(0,i.kt)("h2",{id:"tuning-drift-detection"},"Tuning Drift Detection"),(0,i.kt)("p",null,"From an administrative perspective the controller exposes two options:"),(0,i.kt)("h3",{id:"drift-intervals"},"Drift Intervals"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"driftInterval")," is the amount of time that must pass from the ",(0,i.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration's")," last terraform plan (last transition time recorded within the status of the ",(0,i.kt)("inlineCode",{parentName:"p"},"Configuration")," object), before a new check is run. By default this is ",(0,i.kt)("inlineCode",{parentName:"p"},"3h"),", so every three hours that has passed from the last transition time for a given ",(0,i.kt)("inlineCode",{parentName:"p"},"Configuration")," object, a drift check will be ran against this resource (providing it is within the ",(0,i.kt)("a",{parentName:"p",href:"#drift-threshold"},(0,i.kt)("inlineCode",{parentName:"a"},"driftThreshold")),")."),(0,i.kt)("div",{className:"admonition admonition-important alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"important")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The check is always from the last terraform plan run. So if the ",(0,i.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration")," is altered within those 3 hours, the clocks restarts and will be 3 hours from then."))),(0,i.kt)("p",null,"You can configure the drift interval via the helm value ",(0,i.kt)("inlineCode",{parentName:"p"},"controller.driftInterval"),"; the format must be in minutes or hours, i.e. 10m or 10h"),(0,i.kt)("h3",{id:"drift-threshold"},"Drift Threshold"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"driftThreshold")," is a configurable threshold used to ensure we dont overwhelm the cloud provider API with drift checks. These checks are performing a ",(0,i.kt)("inlineCode",{parentName:"p"},"terraform plan")," afterall and thus API requests are sent out to the cloud provider, so a large collection of ",(0,i.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configurations")," all confirming at the same time could cause API timeouts and retries due to rate limiting."),(0,i.kt)("p",null,"The threshold is a percentage, expressed as a float between 0 and 1. This sets the maximum number of ",(0,i.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration")," that can run a drift check at anyone time."),(0,i.kt)("p",null,"This value takes into account ",(0,i.kt)("strong",{parentName:"p"},"all ",(0,i.kt)("inlineCode",{parentName:"strong"},"Configuration")," resources"),", not just those with ",(0,i.kt)("inlineCode",{parentName:"p"},"enableDriftDetection"),", as the intention is to protect against Cloud API limits."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Scenario 1:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"10 ",(0,i.kt)("inlineCode",{parentName:"li"},"Configuration")," resources"),(0,i.kt)("li",{parentName:"ul"},"1 resource currently in progress (terraform plan or apply is executing)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"driftThreshold: 0.2")," (10 * 20% - maximum 2 resources)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Result:")," A resource with ",(0,i.kt)("inlineCode",{parentName:"li"},"enableDriftCheck")," will execute a check because it is below the threshold")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Scenario 2:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"10 ",(0,i.kt)("inlineCode",{parentName:"li"},"Configuration")," Resources"),(0,i.kt)("li",{parentName:"ul"},"2 resources currently in progress (terraform plan or apply is executing)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"driftThreshold: 0.2")," (10 * 20% - maximum 2 resources)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Result:")," A resource with ",(0,i.kt)("inlineCode",{parentName:"li"},"enableDriftCheck")," will not execute a check because the threshold is currently met. It will be evaluated again after a fixed 5 minute interval.")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Scenario 3:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"10 ",(0,i.kt)("inlineCode",{parentName:"li"},"Configuration")," Resources"),(0,i.kt)("li",{parentName:"ul"},"0 resources currently in progress (terraform plan or apply is executing)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"driftThreshold: 0.01")," (10 * 1% - maximum 1 resource)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Result:")," A resource with ",(0,i.kt)("inlineCode",{parentName:"li"},"enableDriftCheck")," will execute because none are currently in progress, and the maximum resources that can be run is rounded upwards to a value of 1.")),(0,i.kt)("h3",{id:"selection-process"},"Selection Process"),(0,i.kt)("p",null,"The controller chooses a ",(0,i.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration")," based on the following:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Drift detection is enabled on the spec i.e. ",(0,i.kt)("inlineCode",{parentName:"li"},"spec.enableDriftDetection: true"),"."),(0,i.kt)("li",{parentName:"ul"},"The configuration has already ran successfully, i.e. a plan, approve and apply."),(0,i.kt)("li",{parentName:"ul"},"The last time a plan ran was >= drift interval."),(0,i.kt)("li",{parentName:"ul"},"Assuming the number of currently running terraform plan or apply actions is below the drift threshold, the configuration is selected.")),(0,i.kt)("p",null,"The selection process is not ordered in any way, the controller makes a best effort approach, knowing eventually all the ",(0,i.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration")," resources will be run in the end."))}m.isMDXComponent=!0}}]);