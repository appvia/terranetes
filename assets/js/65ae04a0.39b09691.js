"use strict";(self.webpackChunkterranetes=self.webpackChunkterranetes||[]).push([["1898"],{5836:function(e,r,n){n.r(r),n.d(r,{metadata:()=>o,contentTitle:()=>a,default:()=>h,assets:()=>c,toc:()=>l,frontMatter:()=>s});var o=JSON.parse('{"id":"developer/provision","title":"Provisioning a Resource","description":"Terranetes offers two distinct interfaces for provisioning cloud resources: the Configuration Custom Resource Definition (CRD) and the newer CloudResource model. The primary distinction between these interfaces lies in their approach to simplicity and control.","source":"@site/docs/terranetes-controller/developer/provision.md","sourceDirName":"developer","slug":"/developer/provision","permalink":"/terranetes-controller/developer/provision","draft":false,"unlisted":false,"editUrl":"https://github.com/appvia/terranetes/tree/master/docs/terranetes-controller/developer/provision.md","tags":[],"version":"current","lastUpdatedBy":"dependabot[bot]","lastUpdatedAt":1745161423000,"sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Developer Docs","permalink":"/terranetes-controller/category/developer-docs"},"next":{"title":"Terranetes CLI","permalink":"/terranetes-controller/developer/tnctl"}}'),i=n("5893"),t=n("65");let s={sidebar_position:1},a="Provisioning a Resource",c={},l=[{value:"Example CloudResource",id:"example-cloudresource",level:2},{value:"Step 1: Discover Available Resources",id:"step-1-discover-available-resources",level:3},{value:"Step 2: Inspect the Latest Revision of the Service",id:"step-2-inspect-the-latest-revision-of-the-service",level:3},{value:"Step 3: Provision a CloudResource from a Revision",id:"step-3-provision-a-cloudresource-from-a-revision",level:3},{value:"Example Configuration resource",id:"example-configuration-resource",level:2},{value:"Configuration Resource Structure",id:"configuration-resource-structure",level:2},{value:"Module reference",id:"module-reference",level:3},{value:"Provider reference",id:"provider-reference",level:3},{value:"Terraform variables",id:"terraform-variables",level:3},{value:"Connection secret reference",id:"connection-secret-reference",level:3},{value:"Secrets Remapping",id:"secrets-remapping",level:4},{value:"Viewing the changes",id:"viewing-the-changes",level:2},{value:"Approving a plan",id:"approving-a-plan",level:2},{value:"Deleting the resource",id:"deleting-the-resource",level:2}];function d(e){let r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"provisioning-a-resource",children:"Provisioning a Resource"})}),"\n",(0,i.jsxs)(r.p,{children:["Terranetes offers two distinct interfaces for provisioning cloud resources: the ",(0,i.jsx)(r.a,{href:"/terranetes-controller/reference/configurations.terraform.appvia.io",children:"Configuration"})," Custom Resource Definition (CRD) and the newer ",(0,i.jsx)(r.a,{href:"/terranetes-controller/reference/cloudresources.terraform.appvia.io",children:"CloudResource"})," model. The primary distinction between these interfaces lies in their approach to simplicity and control."]}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.a,{href:"/terranetes-controller/reference/configurations.terraform.appvia.io",children:"Configuration"})," CRD provides a direct, one-to-one mapping to the Terraform module, offering a high degree of customization and flexibility. In contrast, the ",(0,i.jsx)(r.a,{href:"/terranetes-controller/reference/cloudresources.terraform.appvia.io",children:"CloudResource"})," interface presents a curated subset of options, enabling platform teams to establish defaults, integrate best practices, and enforce security or organizational policies. This design choice has the added advantage of reducing the cognitive load associated with navigating the extensive range of options available in a Terraform module."]}),"\n",(0,i.jsx)(r.h2,{id:"example-cloudresource",children:"Example CloudResource"}),"\n",(0,i.jsxs)(r.p,{children:["This section outlines the steps to provision a ",(0,i.jsx)(r.a,{href:"/terranetes-controller/reference/cloudresources.terraform.appvia.io",children:"CloudResource"}),"."]}),"\n",(0,i.jsx)(r.h3,{id:"step-1-discover-available-resources",children:"Step 1: Discover Available Resources"}),"\n",(0,i.jsx)(r.p,{children:"To identify the resources available for self-service provisioning, execute the following command to query the cluster for available plans:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"$ kubectl get plans\nNAME       LATEST   AGE\ndatabase   v0.0.1   3s\n"})}),"\n",(0,i.jsx)(r.h3,{id:"step-2-inspect-the-latest-revision-of-the-service",children:"Step 2: Inspect the Latest Revision of the Service"}),"\n",(0,i.jsx)(r.p,{children:"To view the details of the latest revision of the service, use the following command:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"kubectl get revision $(kubectl get plan database -o json | jq .status.latest.name -r) -o yaml\n"})}),"\n",(0,i.jsx)(r.p,{children:"This command will display the options available within the plan."}),"\n",(0,i.jsx)(r.h3,{id:"step-3-provision-a-cloudresource-from-a-revision",children:"Step 3: Provision a CloudResource from a Revision"}),"\n",(0,i.jsx)(r.p,{children:"To create a CloudResource based on a revision, execute the following command:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"tnctl create cloudresource database\n"})}),"\n",(0,i.jsx)(r.p,{children:'This command initiates the provisioning process for a CloudResource named "database" based on the latest revision available.'}),"\n",(0,i.jsx)(r.h2,{id:"example-configuration-resource",children:"Example Configuration resource"}),"\n",(0,i.jsxs)(r.p,{children:["For users employing the ",(0,i.jsx)(r.a,{href:"/terranetes-controller/reference/configurations.terraform.appvia.io",children:"Configuration"})," model, the following example is provided:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:'apiVersion: terraform.appvia.io/v1alpha1\nkind: Configuration\nmetadata:\n  name: bucket\nspec:\n  # SSH example: git::ssh://git@example.com/foo/bar\n  module: https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.1.0\n\n  providerRef:\n    name: default\n\n  writeConnectionSecretToRef:\n    name: test\n\n  # An optional reference to a secret containing credentials to retrieve\n  # the git repository\n  auth:\n    name: <SECRET_NAME>\n\n  # Terraform variables used to populate the module\n  variables:\n    # -- The name of the bucket. If omitted, Terraform will assign a random, unique name\n    bucket: example-test-1234\n    # -- The canned ACL to apply\n    acl: private\n    # -- Map containing versioning configuration\n    versioning:\n      enabled: true\n    # --Whether Amazon S3 should block public ACLs for this bucket\n    block_public_acls: true\n    # -- Whether Amazon S3 should block public bucket policies for this bucket\n    block_public_policy: true\n    # -- Whether Amazon S3 should ignore public ACLs for this bucket\n    ignore_public_acls: true\n    # -- Whether Amazon S3 should restrict public bucket policies for this bucket\n    restrict_public_buckets: true\n    # -- Map containing server-side encryption configuration\n    server_side_encryption_configuration:\n      rule:\n        apply_server_side_encryption_by_default:\n          sse_algorithm: "aws:kms"\n        bucket_key_enabled: true\n'})}),"\n",(0,i.jsxs)(r.admonition,{type:"important",children:[(0,i.jsxs)(r.p,{children:["For releases ",(0,i.jsx)(r.code,{children:"<= v0.2.5"}),", the source syntax specified in ",(0,i.jsx)(r.code,{children:"spec.module"})," does not fully adhere to the recommended ",(0,i.jsx)(r.a,{href:"https://www.terraform.io/language/modules/sources#github",children:"Github format"})," for referencing Github repositories. To ensure compatibility, it is essential to use the following formats for Github references: ",(0,i.jsx)(r.code,{children:"https://github.com/appvia/terraform-aws-rds?ref=TAG"})," or ",(0,i.jsx)(r.code,{children:"git::ssh://git@github.com/appvia/terraform-aws-rds.git"}),"."]}),(0,i.jsxs)(r.p,{children:["It is crucial to follow the syntax guidelines outlined in the ",(0,i.jsx)(r.a,{href:"https://www.terraform.io/language/modules/sources#generic-git-repository",children:"Generic Git Repository"})," documentation to ensure successful module sourcing."]})]}),"\n",(0,i.jsx)(r.h2,{id:"configuration-resource-structure",children:"Configuration Resource Structure"}),"\n",(0,i.jsx)(r.p,{children:"The configuration resource is structured into distinct sections, each serving a specific purpose in the provisioning process."}),"\n",(0,i.jsx)(r.h3,{id:"module-reference",children:"Module reference"}),"\n",(0,i.jsx)(r.p,{children:"The module reference specifies the source location of the Terraform module to be executed."}),"\n",(0,i.jsx)(r.admonition,{type:"tip",children:(0,i.jsxs)(r.p,{children:["This reference adheres to the same format as Terraform itself, leveraging the same library. For comprehensive information, refer to ",(0,i.jsx)(r.a,{href:"https://github.com/hashicorp/go-getter",children:"hashicorp/go-getter"}),"."]})}),"\n",(0,i.jsx)(r.p,{children:"For convenience, the following formats are applicable:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["SSH-based references follow the pattern: ",(0,i.jsx)(r.code,{children:"git::ssh://git@example.com/foo/bar"})]}),"\n",(0,i.jsxs)(r.li,{children:["HTTPS-based references conform to: ",(0,i.jsx)(r.code,{children:"https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.1.0"})]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["Additionally, it is possible to selectively extract specific folders or files from the downloaded module by incorporating the double slash notation: ",(0,i.jsx)(r.code,{children:"[URL]//dir/file"}),"."]}),"\n",(0,i.jsx)(r.h3,{id:"provider-reference",children:"Provider reference"}),"\n",(0,i.jsxs)(r.p,{children:["The provider reference is a crucial element that establishes the connection between a configuration and the credentials required to communicate with the cloud. Depending on the Kubernetes RBAC you currently possess, you can retrieve a list of the current providers via ",(0,i.jsx)(r.code,{children:"kubectl"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"$ kubectl get providers -n [NAMESPACE]\n"})}),"\n",(0,i.jsxs)(r.p,{children:["Once you have the provider ",(0,i.jsx)(r.code,{children:"name"}),", you can use the reference in the configuration:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"spec:\n  providerRef:\n    name: <NAME>\n"})}),"\n",(0,i.jsx)(r.h3,{id:"terraform-variables",children:"Terraform variables"}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"spec.variables"})," section is a map that enables the definition of all variables that can be utilized by the module. These variables are transformed into HCL format and injected into the workflow through the ",(0,i.jsx)(r.code,{children:"-var-file"})," option during both the ",(0,i.jsx)(r.code,{children:"plan"})," and ",(0,i.jsx)(r.code,{children:"apply"})," phases."]}),"\n",(0,i.jsxs)(r.p,{children:["When dealing with sensitive variables, such as passwords, it is advisable to leverage the ",(0,i.jsx)(r.code,{children:"spec.valueFrom"})," field. This field comprises a collection of references to Kubernetes secrets that store the actual values of these sensitive variables."]}),"\n",(0,i.jsx)(r.admonition,{type:"important",children:(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"spec.valueFrom"})," field is available from version >= v0.1.6"]})}),"\n",(0,i.jsx)(r.p,{children:"An example for an RDS module can be"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"spec:\n  valueFrom:\n    - secret: db_password\n      key: database_password\n      optional: false\n"})}),"\n",(0,i.jsx)(r.h3,{id:"connection-secret-reference",children:"Connection secret reference"}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"spec.writeConnectionSecretToRef"})," field specifies the name of a secret within the namespace where Terraform outputs are written. These outputs are automatically converted to environment variable format, ensuring they are uppercase and readily consumable by workloads utilizing ",(0,i.jsx)(r.a,{href:"https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets-as-environment-variables",children:"env and envFrom"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["By default, when a secret is defined, all Terraform outputs are written in environment variable form. To selectively include specific keys from the Terraform output, you can incorporate the ",(0,i.jsx)(r.code,{children:"spec.writeConnectionSecretToRef.keys"})," field, as demonstrated below."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"spec:\n  writeConnectionSecretToRef:\n    name: [NAME]\n    keys:\n      - name_of_key\n      - name_of_key\n"})}),"\n",(0,i.jsx)(r.h4,{id:"secrets-remapping",children:"Secrets Remapping"}),"\n",(0,i.jsxs)(r.p,{children:["The Terraform controller uses the resource outputs as the keys in the connection secret. For example, if a resource has a ",(0,i.jsx)(r.code,{children:"database_endpoint"})," output, the secret will have a key named ",(0,i.jsx)(r.code,{children:"DATABASE_ENDPOINT"}),". However, you might want to rename one or more outputs for convenience. For instance, you can change the ",(0,i.jsx)(r.code,{children:"database_endpoint"})," to ",(0,i.jsx)(r.code,{children:"mysql_host"})," as shown below:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"apiVersion: terraform.appvia.io/v1alpha1\nkind: Configuration|CloudResource\nmetadata:\n  name: bucket\nspec:\n  providerRef:\n    name: aws\n  writeConnectionSecretToRef:\n    name: test\n    keys:\n      - database_endpoint:mysql_host # is renamed to MYSQL_HOST\n      - database_port                # is unchanged as DATABASE_PORT\n"})}),"\n",(0,i.jsx)(r.h2,{id:"viewing-the-changes",children:"Viewing the changes"}),"\n",(0,i.jsxs)(r.p,{children:["During the lifecycle of a Configuration, including its plan, apply, and destroy phases, a job is spawned within the namespace to facilitate the tracking of the change's execution. These jobs adhere to a standardized naming convention, ",(0,i.jsx)(r.code,{children:"[RESOURCE]-[GENERATION]-[plan|apply|destroy]"}),", allowing for easy identification. To monitor the progress of a change, you can examine the logs of the corresponding pod using the command ",(0,i.jsx)(r.code,{children:"kubectl logs [POD]"}),"."]}),"\n",(0,i.jsxs)(r.p,{children:["Alternatively, the ",(0,i.jsx)(r.a,{href:"/terranetes-controller/developer/tnctl",children:"tnctl"})," command-line interface offers a convenient method for accessing logs, as demonstrated below:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"$ tnctl logs -n NAMESPACE NAME\n"})}),"\n",(0,i.jsx)(r.h2,{id:"approving-a-plan",children:"Approving a plan"}),"\n",(0,i.jsxs)(r.p,{children:["By default, all Configurations and CloudResources require manual approval before execution, unless ",(0,i.jsx)(r.code,{children:"spec.enableAutoApproval"})," is explicitly set to ",(0,i.jsx)(r.code,{children:"true"}),". To facilitate this approval process, an annotation can be applied directly to the Configuration or CloudResource."]}),"\n",(0,i.jsxs)(r.p,{children:["To manually approve the Configuration named ",(0,i.jsx)(r.code,{children:"bucket"}),", execute one of the following commands:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:'$ kubectl -n apps annotate configuration bucket "terraform.appvia.io/apply"=true --overwrite\n'})}),"\n",(0,i.jsx)(r.p,{children:"Alternatively, for CloudResources:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:'$ kubectl -n apps annotate cloudresource bucket "terraform.appvia.io/apply"=true --overwrite\n'})}),"\n",(0,i.jsxs)(r.p,{children:["For a more streamlined approach, the ",(0,i.jsx)(r.a,{href:"/terranetes-controller/developer/tnctl",children:"tnctl"})," command-line interface provides a dedicated approval mechanism. To approve a Configuration or CloudResource using tnctl, use the following command:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-shell",children:"$ tnctl approve cloudresource|configuration -n NAMESPACE NAME\n"})}),"\n",(0,i.jsx)(r.p,{children:"This annotation or tnctl command effectively signals approval for the specified resource, allowing the Terraform controller to proceed with the execution of the plan."}),"\n",(0,i.jsx)(r.h2,{id:"deleting-the-resource",children:"Deleting the resource"}),"\n",(0,i.jsxs)(r.p,{children:["Deleting a resource is a standard operation in Kubernetes, and can be done using the command ",(0,i.jsx)(r.code,{children:"kubectl delete configuration [NAME]"}),". An additional feature is the ability to orphan the cloud resources, meaning that the Kubernetes representation is deleted, but the cloud resources themselves are not."]}),"\n",(0,i.jsx)(r.p,{children:"For example, if you need to migrate a configuration to another cluster, follow these steps:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Annotate the Configuration with ",(0,i.jsx)(r.code,{children:'kubectl annotate configuration [NAME] "terraform.appvia.io/orphan"=true'})]}),"\n",(0,i.jsx)(r.li,{children:"Delete the Configuration resource as usual. The resource will be removed, but the cloud resources will remain."}),"\n"]})]})}function h(e={}){let{wrapper:r}={...(0,t.a)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},65:function(e,r,n){n.d(r,{Z:function(){return a},a:function(){return s}});var o=n(7294);let i={},t=o.createContext(i);function s(e){let r=o.useContext(t);return o.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(t.Provider,{value:r},e.children)}}}]);