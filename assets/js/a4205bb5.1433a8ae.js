"use strict";(self.webpackChunkterranetes=self.webpackChunkterranetes||[]).push([[6176],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(n),m=o,f=d["".concat(s,".").concat(m)]||d[m]||u[m]||a;return n?r.createElement(f,i(i({ref:t},c),{},{components:n})):r.createElement(f,i({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<a;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},1076:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var r=n(7462),o=(n(7294),n(3905));const a={sidebar_position:1},i="Provisioning a Terraform Module",l={unversionedId:"developer/configuration",id:"developer/configuration",title:"Provisioning a Terraform Module",description:"Example configuration resource",source:"@site/docs/terranetes-controller/developer/configuration.md",sourceDirName:"developer",slug:"/developer/configuration",permalink:"/terranetes-controller/developer/configuration",draft:!1,editUrl:"https://github.com/appvia/terranetes/tree/master/docs/terranetes-controller/developer/configuration.md",tags:[],version:"current",lastUpdatedBy:"Rohith Jayawardene",lastUpdatedAt:1662029886,formattedLastUpdatedAt:"Sep 1, 2022",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Developer Docs",permalink:"/terranetes-controller/category/developer-docs"},next:{title:"Terranetes CLI",permalink:"/terranetes-controller/developer/tnctl"}},s={},p=[{value:"Example configuration resource",id:"example-configuration-resource",level:2},{value:"Sections of the configuration resource",id:"sections-of-the-configuration-resource",level:2},{value:"Module reference",id:"module-reference",level:3},{value:"Provider reference",id:"provider-reference",level:3},{value:"Terraform variables",id:"terraform-variables",level:3},{value:"Connection secret reference",id:"connection-secret-reference",level:3},{value:"Secrets Remapping",id:"secrets-remapping",level:4},{value:"Viewing the changes",id:"viewing-the-changes",level:2},{value:"Approving a plan",id:"approving-a-plan",level:2},{value:"Deleting the resource",id:"deleting-the-resource",level:2}],c={toc:p};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"provisioning-a-terraform-module"},"Provisioning a Terraform Module"),(0,o.kt)("h2",{id:"example-configuration-resource"},"Example configuration resource"),(0,o.kt)("p",null,"On the consumption side the only resource required is the ",(0,o.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration")," CRD. Below is an example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: terraform.appvia.io/v1alpha1\nkind: Configuration\nmetadata:\n  name: bucket\nspec:\n  # ssh example: git::ssh://git@example.com/foo/bar\n  module: https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.1.0\n\n  providerRef:\n    name: default\n\n  writeConnectionSecretToRef:\n    name: test\n\n  # An optional reference to a secret containing credentials to retrieve\n  # the git repository\n  auth:\n    name: <SECRET_NAME>\n\n  # Terraform variables used to populate the module\n  variables:\n    # -- The name of the bucket. If omitted, Terraform will assign a random, unique name\n    bucket: rohith-test-1234\n    # -- The canned ACL to apply\n    acl: private\n    # -- Map containing versioning configuration\n    versioning:\n      enabled: true\n    # --Whether Amazon S3 should block public ACLs for this bucket\n    block_public_acls: true\n    # -- Whether Amazon S3 should block public bucket policies for this bucket\n    block_public_policy: true\n    # -- Whether Amazon S3 should ignore public ACLs for this bucket\n    ignore_public_acls: true\n    # -- Whether Amazon S3 should restrict public bucket policies for this bucket\n    restrict_public_buckets: true\n    # -- Map containing server-side encryption configuration\n    server_side_encryption_configuration:\n      rule:\n        apply_server_side_encryption_by_default:\n          sse_algorithm: "aws:kms"\n        bucket_key_enabled: true\n')),(0,o.kt)("admonition",{type:"important"},(0,o.kt)("p",{parentName:"admonition"},"The source syntax ",(0,o.kt)("em",{parentName:"p"},"(spec.module)")," on releases ",(0,o.kt)("inlineCode",{parentName:"p"},"<= v0.2.5")," does not fully support suggested ",(0,o.kt)("a",{parentName:"p",href:"https://www.terraform.io/language/modules/sources#github"},"Github format"),". References to Github must use the ",(0,o.kt)("inlineCode",{parentName:"p"},"https://github.com/appvia/terraform-aws-rds?ref=TAG")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"git::ssh://git@github.com/appvia/terraform-aws-rds.git"),"."),(0,o.kt)("p",{parentName:"admonition"},"Following the syntax of ",(0,o.kt)("a",{parentName:"p",href:"https://www.terraform.io/language/modules/sources#generic-git-repository"},"Generic Git Repository"),".")),(0,o.kt)("h2",{id:"sections-of-the-configuration-resource"},"Sections of the configuration resource"),(0,o.kt)("p",null,"The configuration resource is comprised of the following sections."),(0,o.kt)("h3",{id:"module-reference"},"Module reference"),(0,o.kt)("p",null,"The module reference defines the source of the terraform module to run."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The source reference uses the exact same format as terraform itself (the same library is used). For full details take a look at ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/hashicorp/go-getter"},"hashicorp/go-getter"),".")),(0,o.kt)("p",null,"For quick reference:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Using SSH the format would look like this: ",(0,o.kt)("inlineCode",{parentName:"li"},"git::ssh://git@example.com/foo/bar")),(0,o.kt)("li",{parentName:"ul"},"Using HTTPS the format would be: ",(0,o.kt)("inlineCode",{parentName:"li"},"https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.1.0"))),(0,o.kt)("p",null,"You can also extract specific folders or files from the downloaded module by using the double slash: ",(0,o.kt)("inlineCode",{parentName:"p"},"[URL]//dir/file"),"."),(0,o.kt)("h3",{id:"provider-reference"},"Provider reference"),(0,o.kt)("p",null,"The provider reference is what links a configuration to the credentials used to speak to the cloud. Depending on the Kubernetes RBAC you currently posses you can retrieve a list of the current providers via ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl get providers -n [NAMESPACE]\n")),(0,o.kt)("p",null,"Once you have the provider ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," you use the reference in the configuration:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  providerRef:\n    name: <NAME>\n")),(0,o.kt)("h3",{id:"terraform-variables"},"Terraform variables"),(0,o.kt)("p",null,"The variables section ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.variables")," is a freeform map used to define all the variables the module can consume. These are converted to HCL and provided into the workflow via ",(0,o.kt)("inlineCode",{parentName:"p"},"-var-file")," on the ",(0,o.kt)("inlineCode",{parentName:"p"},"plan")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"apply")," stages."),(0,o.kt)("p",null,"For variables that are sensitive such as passwords it would be better to use the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.valueFrom")," field. This is a collection of references to kubernetes secrets that hold the values."),(0,o.kt)("admonition",{type:"important"},(0,o.kt)("p",{parentName:"admonition"},"ValueFrom fields is available from version >= v0.1.6")),(0,o.kt)("p",null,"An example for an RDS module can be"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"spec:\n  valueFrom:\n    - secret: db_password\n      key: database_password\n      optional: false\n")),(0,o.kt)("h3",{id:"connection-secret-reference"},"Connection secret reference"),(0,o.kt)("p",null,"The connection secret ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.writeConnectionSecretToRef")," is the name of a secret within the namespace where you want any Terraform outputs to be written. These outputs are converted to environment variable format, i.e., upper-cased and ready to be consumed by workloads using ",(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/configuration/secret/#using-secrets-as-environment-variables"},"env and envFrom"),"."),(0,o.kt)("p",null,"By default when a secret is defined all the outputs produced are written in environment variable form. If you want to filter this and only select specific keys from the terraform output you can include the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.writeConnectionSecretToRef.keys")," field as shown below."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"spec:\n  writeConnectionSecretToRef:\n    name: [NAME]\n    keys:\n      - name_of_key\n      - name_of_key\n")),(0,o.kt)("h4",{id:"secrets-remapping"},"Secrets Remapping"),(0,o.kt)("p",null,"We use the resource outputs as the keys in the connection secret, so if a resource has a ",(0,o.kt)("inlineCode",{parentName:"p"},"database_endpoint")," output the secret will have a key named ",(0,o.kt)("inlineCode",{parentName:"p"},"DATABASE_ENDPOINT"),". You might want to rename one or more outputs for convenience however, for example change the ",(0,o.kt)("inlineCode",{parentName:"p"},"database_endpoint")," to ",(0,o.kt)("inlineCode",{parentName:"p"},"mysql_host"),". You can change the key like below"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: terraform.appvia.io/v1alpha1\nkind: Configuration\nmetadata:\n  name: bucket\nspec:\n  module: https://github.com/terraform-aws-modules/terraform-aws-rds.git?ref=v3.1.0\n  providerRef:\n    name: aws\n  writeConnectionSecretToRef:\n    name: test\n    keys:\n      - database_endpoint:mysql_host # is renamed to MYSQL_HOST\n      - database_port                # is unchanged as DATABASE_PORT\n")),(0,o.kt)("h2",{id:"viewing-the-changes"},"Viewing the changes"),(0,o.kt)("p",null,"As a Configuration transitions through its plan, apply and destroy phases, a job is created in the namespace, and used to feedback the execution of the change. The jobs follows the naming format ",(0,o.kt)("inlineCode",{parentName:"p"},"[RESOURCE]-[GENERATION]-[plan|apply|destroy]"),". You can easily view the execution of a change by inspecting the pod's logs (",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl logs [POD]"),")."),(0,o.kt)("h2",{id:"approving-a-plan"},"Approving a plan"),(0,o.kt)("p",null,"By default, unless the ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.enableAutoApproval")," is set to true, all Configurations require a manual approval. You can do this by toggling an annotation on the Configuration itself."),(0,o.kt)("p",null,"To approve the Configuration ",(0,o.kt)("inlineCode",{parentName:"p"},"bucket"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'$ kubectl -n apps annotate configurations bucket "terraform.appvia.io/apply"=true\n')),(0,o.kt)("h2",{id:"deleting-the-resource"},"Deleting the resource"),(0,o.kt)("p",null,"You can delete the resource like any other Kubernetes resource (",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl delete configuration [NAME]"),"). One extra feature is the ability to orphan the cloud resources (i.e., delete the Kubernetes representation but DO NOT delete the cloud resources themselves)."),(0,o.kt)("p",null,"For instance, you may need to migrate the configuration to another cluster. In that case:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Annotate the Configuration with ",(0,o.kt)("inlineCode",{parentName:"li"},'kubectl annotate configuration [NAME] "terraform.appvia.io/orphan"=true')),(0,o.kt)("li",{parentName:"ol"},"Delete the Configuration resource as per normal. The resource will disappear but the cloud resources will remain.")))}u.isMDXComponent=!0}}]);