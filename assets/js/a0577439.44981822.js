"use strict";(self.webpackChunkterranetes=self.webpackChunkterranetes||[]).push([[5050],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>f});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),f=a,m=d["".concat(l,".").concat(f)]||d[f]||u[f]||o;return n?r.createElement(m,i(i({ref:t},p),{},{components:n})):r.createElement(m,i({ref:t},p))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},6834:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var r=n(7462),a=(n(7294),n(3905));const o={sidebar_position:3,sidebar_class_name:"green"},i="Configuration Contexts",s={unversionedId:"admin/contexts",id:"admin/contexts",title:"Configuration Contexts",description:"Contexts provide a means to share common configuration between Configurations. The resource type is Cluster scoped and can be used by any Configuration in the cluster.",source:"@site/docs/terranetes-controller/admin/contexts.md",sourceDirName:"admin",slug:"/admin/contexts",permalink:"/terranetes-controller/admin/contexts",draft:!1,editUrl:"https://github.com/appvia/terranetes/tree/master/docs/terranetes-controller/admin/contexts.md",tags:[],version:"current",lastUpdatedBy:"Rohith Jayawardene",lastUpdatedAt:1684764858,formattedLastUpdatedAt:"May 22, 2023",sidebarPosition:3,frontMatter:{sidebar_position:3,sidebar_class_name:"green"},sidebar:"tutorialSidebar",previous:{title:"Checkov Policy",permalink:"/terranetes-controller/admin/policy/checkov"},next:{title:"Expose Costs",permalink:"/terranetes-controller/admin/costs"}},l={},c=[{value:"Create a Context",id:"create-a-context",level:2},{value:"Configure Preloading",id:"configure-preloading",level:2},{value:"How to reference a Context",id:"how-to-reference-a-context",level:2}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"configuration-contexts"},"Configuration Contexts"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/contexts.terraform.appvia.io"},"Contexts")," provide a means to share common configuration between ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configurations"),". The resource type is Cluster scoped and can be used by any Configuration in the cluster."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"This feature is only available from v0.3.25 onwards")),(0,a.kt)("h2",{id:"create-a-context"},"Create a Context"),(0,a.kt)("p",null,"You can create a ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/contexts.terraform.appvia.io"},"Context")," like so."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"---\napiVersion: terraform.appvia.io/v1alpha1\nkind: Context\nmetadata:\n  name: default\nspec:\n  #\n  ## All variables MUST follow the pattern of 'description' and 'value'. The\n  ## value can be any complex or simple type (boolean, int, map, object etc)\n  #\n  variables:\n    # Is the name of the variable\n    vpc_id:\n      # Provides a description to the consumer of the input\n      description: Is the network identifier we are residing\n      # The value of the value\n      value: vpc-1223133113\n    public_subnets_ids:\n      # Provides a description to the consumer of the input\n      description: |\n        Is a collection of subnet id's which are publicly available i.e.\n        they are attached to an internet gateway\n      # The value of the value\n      value:\n        - subnet-12312312312\n        - subnet-32332321312\n")),(0,a.kt)("p",null,"The resource contains a map of variables; note each variable MUST have a ",(0,a.kt)("inlineCode",{parentName:"p"},"description")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"value"),", with the value being any simple (integer, boolean, string) or complex type (maps, list, maps or maps and so forth)."),(0,a.kt)("h2",{id:"configure-preloading"},"Configure Preloading"),(0,a.kt)("p",null,"Terranetes has the ability to populate a ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/contexts.terraform.appvia.io"},"Context")," automatically; retrieving details about the cluster the controller resides and populating them into a ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/contexts.terraform.appvia.io"},"Context"),". Currently this feature is limited to AWS only."),(0,a.kt)("p",null,"In order to use the feature we need to update the configuration of a ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/providers.terraform.appvia.io"},"Provider"),"; It is the ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/providers.terraform.appvia.io"},"Providers")," credentials which the preloading will use to retrieve the information from the cloud vendor."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"---\napiVersion: terraform.appvia.io/v1alpha1\nkind: Provider\nmetadata:\n  name: aws\nspec:\n  # Source and be 'secret' or 'injected'. When using a 'secret' you\n  # must specify the spec.secretRef which defines the name of the\n  # secret in the controller namespace containing the credentials.\n  source: secret\n  # Provider can be google, aws, azurerm, alicloud, azurestack, googleworkspace etc\n  provider: aws\n  # Provides configuration for the contextual data preloader (currently only\n  # available for aws)\n  preload:\n    # Indicates if the preloading should be enabled\n    enabled: true\n    # Is the EKS cluster we use to pivot network and settings around\n    cluster: eks\n    # Is the cloud region the cluster above resides\n    region: eu-west-2\n    # Is the terranetes context resource we should provision\n    context: default\n  # Used when spec.source is secret.\n  secretRef:\n    namespace: terraform-system\n    name: aws\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"spec.preload")," in the ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/providers.terraform.appvia.io"},"Provider")," needs the following information."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"enabled")," Indicates if we should preload any data into a ",(0,a.kt)("a",{parentName:"li",href:"/terranetes-controller/reference/contexts.terraform.appvia.io"},"Context"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"cluster")," Is the cloud name of the cluster we reside in i.e. the EKS cluster name."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"region")," Is the cloud region the cluster (",(0,a.kt)("inlineCode",{parentName:"li"},"spec.preload.cluster"),") resides in."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"context")," Is the name of the ",(0,a.kt)("a",{parentName:"li",href:"/terranetes-controller/reference/contexts.terraform.appvia.io"},"Context")," you wish to populate the values into.")),(0,a.kt)("p",null,"Once this information has been defined, a ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/contexts.terraform.appvia.io"},"Context")," resource be automatically provisioned and preloaded with details, as such;"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"[jest@starfury terranetes-controller]$ k get contexts.terraform.appvia.io default  -o yaml\napiVersion: terraform.appvia.io/v1alpha1\nkind: Context\nmetadata:\n  generation: 1\n  labels:\n    terranetes.appvia.io/preload-provider-name: aws\n  name: default\nspec:\n  variables:\n    eks:\n      description: AWS ARN for the Kubernetes cluster\n      value: arn:aws:eks:eu-west-2:XXXXXXXXX:cluster/eks-test\n    eks_cluster_security_group_id:\n      description: The security group ID attached to the EKS cluster\n      value: sg-XXXXXXXXX\n    eks_endpoint:\n      description: The endpoint for the EKS cluster\n      value: https://XXXXXXXXXXXXXXXX.sk1.eu-west-2.eks.amazonaws.com\n    eks_name:\n      description: The name of the EKS cluster\n      value: eks\n    eks_platform_version:\n      description: The platform version of the EKS cluster\n      value: eks.6\n    eks_private_access:\n      description: Indicates whether or not the EKS cluster has private access enabled\n      value: true\n    eks_public_access:\n      description: Indicates whether or not the EKS cluster has public access enabled\n      value: false\n    eks_public_access_cidrs:\n      description: The CIDR blocks that are allowed access to the EKS cluster\n      value:\n      - 0.0.0.0/0\n    eks_role_arn:\n      description: The ARN of the IAM role that provides permissions for the EKS cluster\n      value: arn:aws:iam::XXXXXXXXXX:role/eks-test-role\n    eks_route_tables_ids:\n      description: A list of all route tables id associate to the subnets which are\n        part of the EKS cluster\n      value:\n      - rtb-04dbff51b83821XXX\n     ....MORE VARIABLES\n    vpc_id:\n      description: The ID of the VPC used by the EKS cluster\n      value: vpc-0a6f4fbb4bXXXXXXX\n")),(0,a.kt)("h2",{id:"how-to-reference-a-context"},"How to reference a Context"),(0,a.kt)("p",null,"Contexts can be referenced from any ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration")," like so"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"  ---\n  apiVersion: terraform.appvia.io/v1alpha1\n  kind: Configuration\n  metadata:\n    name: bucket\n  spec:\n    module: https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.10.1\n\n    providerRef:\n      name: aws\n\n    # Allows you to source in terraform inputs from one of more kubernetes secrets\n    valueFrom:\n      -\n        # Retrieve the value from a specific context\n        context: default\n        # Is the key with the context resource which we should use. The translates\n        # to spec.variables.KEY.value\n        key: vpc\n        # Is the name which the value should be presented to terraform as\n        name: vpc_id\n        # Indicates the value, or context is not found is optional and will not fail the\n        # terraform run\n        optional: true\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"spec.valueFrom")," requires the ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/contexts.terraform.appvia.io"},"Context")," name, the key is the name of the variable in the context and the name is the variable you need to present this as to the terraform module. The optional field simply means both the context and any value reference, if they don't exist, can continue without failure. By default, anything missing (context or value) will defer the ",(0,a.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration")," until they are present."))}u.isMDXComponent=!0}}]);