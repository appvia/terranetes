"use strict";(self.webpackChunkterranetes=self.webpackChunkterranetes||[]).push([[5359],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>d});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(a),d=o,h=u["".concat(s,".").concat(d)]||u[d]||m[d]||r;return a?n.createElement(h,i(i({ref:t},p),{},{components:a})):n.createElement(h,i({ref:t},p))}));function d(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,i=new Array(r);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var c=2;c<r;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},5974:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var n=a(7462),o=(a(7294),a(3905));const r={sidebar_position:2,sidebar_class_name:"green"},i="Define Guardrails",l={unversionedId:"admin/policy",id:"admin/policy",title:"Define Guardrails",description:"The controller comes with a number of controls and safeguards that the platform team can utilize to:",source:"@site/docs/terranetes-controller/admin/policy.md",sourceDirName:"admin",slug:"/admin/policy",permalink:"/terranetes-controller/admin/policy",draft:!1,editUrl:"https://github.com/appvia/terranetes/tree/master/docs/terranetes-controller/admin/policy.md",tags:[],version:"current",lastUpdatedBy:"Rohith Jayawardene",lastUpdatedAt:1661443475,formattedLastUpdatedAt:"Aug 25, 2022",sidebarPosition:2,frontMatter:{sidebar_position:2,sidebar_class_name:"green"},sidebar:"tutorialSidebar",previous:{title:"Configure Providers",permalink:"/terranetes-controller/admin/providers"},next:{title:"Expose Costs",permalink:"/terranetes-controller/admin/costs"}},s={},c=[{value:"Policy Resource",id:"policy-resource",level:2},{value:"Module Security",id:"module-security",level:2},{value:"Checkov Security Policy",id:"checkov-security-policy",level:2},{value:"Defining checkov policies",id:"defining-checkov-policies",level:3},{value:"Using external checks",id:"using-external-checks",level:3},{value:"Rules for selecting the security policy",id:"rules-for-selecting-the-security-policy",level:3},{value:"Default Variables",id:"default-variables",level:2}],p={toc:c};function m(e){let{components:t,...a}=e;return(0,o.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"define-guardrails"},"Define Guardrails"),(0,o.kt)("p",null,"The controller comes with a number of controls and safeguards that the platform team can utilize to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Enforce a security policy across the estate via ",(0,o.kt)("a",{parentName:"li",href:"https://www.checkov.io/"},"Checkov"),"."),(0,o.kt)("li",{parentName:"ul"},"Enforce the source of the terraform modules, for example locking down to only fetch terraform modules from your company's repositories."),(0,o.kt)("li",{parentName:"ul"},"Automatically inject environment-specific variables into the Configuration CRD, such as costs, project IDs, environment-specific labels or tags. This removes the need for teams consuming modules to know these details, and keeps the deployments environment agnostic.")),(0,o.kt)("h2",{id:"policy-resource"},"Policy Resource"),(0,o.kt)("p",null,"Not wishing to create a plethora of resource types to define all mechanics of policy, all the policies handled by the controller are defined via the ",(0,o.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/policies.terraform.appvia.io"},"Policy")," CRD."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"You can define Policy resources multiple times, as the definitions are pulled together and aggregated.")),(0,o.kt)("h2",{id:"module-security"},"Module Security"),(0,o.kt)("p",null,"You can control the source of the terraform modules permitted to run through the ",(0,o.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/policies.terraform.appvia.io"},"Policy")," resource. The following policy enforces that only modules sourced from the Appvia Github Organization can be used."),(0,o.kt)("admonition",{type:"important"},(0,o.kt)("p",{parentName:"admonition"},"This control is applied to the primary module (i.e. ",(0,o.kt)("inlineCode",{parentName:"p"},"spec.module"),") inside the Configuration CRD. Modules that incorporate other modules are not enforced.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: terraform.appvia.io/v1alpha1\nkind: Policy\nmetadata:\n  name: permitted-modules\nspec:\n  constraints:\n    selector:\n      namespace:\n        matchLabels: {}\n        matchExpressions: []\n      resource:\n        matchLabels: {}\n        matchExpressions: []\n    modules:\n      allowed:\n        - "https://github.com/appvia/.*"\n')),(0,o.kt)("p",null,"The allowed list (",(0,o.kt)("inlineCode",{parentName:"p"},"spec.constraints.modules.allowed"),") is a collection of Golang regexes which a ",(0,o.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration")," must match at least one."),(0,o.kt)("p",null,"The policy may also include an optional selector (",(0,o.kt)("inlineCode",{parentName:"p"},"spec.constraints.modules.selector"),") that can be used to match against namespace and resource labels of the ",(0,o.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configuration"),". As with all selectors in the controller, leaving this field empty implies you want to match against all. You can take advantage of the selectors by providing overrides."),(0,o.kt)("p",null,"Lets use the following requirements."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"All teams may use terraform from the companies Github repositories at ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/appvia"},"https://github.com/appvia")),(0,o.kt)("li",{parentName:"ul"},"The teams using namespace ",(0,o.kt)("inlineCode",{parentName:"li"},"infra")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"ci")," can use additional modules from ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/elsewhere"},"https://github.com/elsewhere"))),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create the default policy (i.e no selector)")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: terraform.appvia.io/v1alpha1\nkind: Policy\nmetadata:\n  name: default\nspec:\n  constraints:\n    modules:\n      allowed:\n        - "https://github.com/appvia/.*"\n')),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Create the additional policy for namespace ",(0,o.kt)("inlineCode",{parentName:"li"},"infra")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"ci"),".")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: terraform.appvia.io/v1alpha1\nkind: Policy\nmetadata:\n  name: default\nspec:\n  constraints:\n    selector:\n      namespace:\n        matchExpressions:\n          - key: kubernetes.io/metadata.name\n            operator: In\n            values: [infra, ci]\n    modules:\n      allowed:\n        - "https://github.com/elsewhere/.*"\n')),(0,o.kt)("h2",{id:"checkov-security-policy"},"Checkov Security Policy"),(0,o.kt)("p",null,"Security policy allows platform teams to be assured what they are allowing to be self-serviced follows what they and the organization deem to be best practice. All terraform configurations are funnelled through a security check as part of the plan stage."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The security checks are performed on the terraform plan, not the static module, so you have the added benefit that anything they import is scanned and any variables or dynamic variation is included in the scan.")),(0,o.kt)("p",null,"Once the security plan is performed the report is processed and, assuming no failed checks, is allowed to continue on to be applied (either automatically or via the annotation)."),(0,o.kt)("h3",{id:"defining-checkov-policies"},"Defining checkov policies"),(0,o.kt)("p",null,"Again we are using the ",(0,o.kt)("a",{parentName:"p",href:"/terranetes-controller/reference/policies.terraform.appvia.io"},"Policy")," here to define the rule:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: terraform.appvia.io/v1alpha1\nkind: Policy\nmetadata:\n  name: checkov\nspec:\n  constraints:\n    # Allows you to filter on which configurations the policy should apply. If left\n    # blank, this policy is a catch-all and applied to all terraform configurations.\n    selector:\n      # Used to filter on namespace labels\n      namespace:\n        matchLabels: {}\n        matchExpressions: []\n      # Used to filter on the configuration labels\n      resource:\n        matchLabels: {}\n        matchExpressions: []\n\n    checkov:\n      # See: https://www.checkov.io/5.Policy%20Index/terraform.html\n      checks: []\n      # See: https://www.checkov.io/5.Policy%20Index/terraform.html\n      skipChecks: []\n")),(0,o.kt)("admonition",{type:"important"},(0,o.kt)("ul",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ul"},"If no ",(0,o.kt)("inlineCode",{parentName:"li"},"checkov.checks")," are defined, the entire checkov suite is evaluated."),(0,o.kt)("li",{parentName:"ul"},"If ",(0,o.kt)("inlineCode",{parentName:"li"},"checkov.skipChecks")," are defined, those will be ignored during evaluation."))),(0,o.kt)("h3",{id:"using-external-checks"},"Using external checks"),(0,o.kt)("p",null,"The controller also has the ability to source multiple ",(0,o.kt)("a",{parentName:"p",href:"https://www.checkov.io/3.Custom%20Policies/Custom%20Policies%20Overview.html"},"custom policies"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: terraform.appvia.io/v1alpha1\nkind: Policy\nmetadata:\n  name: checkov\nspec:\n  constraints:\n    checkov:\n      external:\n        - name: custom\n          url: https://[LOCATION]\n          secretRef:\n            name: [SECRET]\n")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The URL uses the same format at the ","[Configuration]","(/terranetes-controller/reference/configurations.terraform.appvia.io] CRD."),(0,o.kt)("li",{parentName:"ol"},"The secretRef is optional and used to store any credentials used to retrieves the assets. Like ",(0,o.kt)("a",{parentName:"li",href:"/terranetes-controller/reference/configurations.terraform.appvia.io"},"Configurations")," we support object stores, git repositories and so forth."),(0,o.kt)("li",{parentName:"ol"},"All assets found in the source are retrieved and used an ",(0,o.kt)("a",{parentName:"li",href:"https://www.checkov.io/2.Basics/CLI%20Command%20Reference.html"},"external-checks-dir")," option to the scan.")),(0,o.kt)("h3",{id:"rules-for-selecting-the-security-policy"},"Rules for selecting the security policy"),(0,o.kt)("p",null,"You can define multiple checkov policies using selectors to target specific workloads, however, you can only have one match. The selection process for this is as follows:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"If the checkov policy does not have a selector it is applied to all resources."),(0,o.kt)("li",{parentName:"ol"},"If the checkov policy has a matching namespace selector it adds additional priority/weight."),(0,o.kt)("li",{parentName:"ol"},"If the checkov policy has a matching resource selector it adds even more priority/weight."),(0,o.kt)("li",{parentName:"ol"},"The total weights are added up and the highest matching checkov policy is used."),(0,o.kt)("li",{parentName:"ol"},"If you have checkov policies with the same weight, the controller throws an error.")),(0,o.kt)("p",null,"At the end we have selected the checkov policy which is most specific to our Configuration."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Why not merge multiple policies?")),(0,o.kt)("p",null,"We had the same idea, whereby we'd simply merge multiple policies together. The reasoning here is that adding an additional policy is needed to allow for an exception to the rule. For example, if we define that all RDS databases must use encryption, but project 'A' can't do that, we need an exception. But policies are enforced because they strengthen security, so adding exceptions should be difficult/annoying in order to push for the better solution: fixing project A's lack of compliance."),(0,o.kt)("h2",{id:"default-variables"},"Default Variables"),(0,o.kt)("p",null,"Default environments provide the ability to inject environment-specific variables into a configuration based on a selector. An example might be:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Adding environment-specific options (e.g. VPC ID, tags, etc), elements that you don't want developers to have to deal with"),(0,o.kt)("li",{parentName:"ul"},"Adding project-specific tags (e.g. cost center codes, project ID, etc)")),(0,o.kt)("p",null,"You can configure these via a Policy resource. For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: terraform.appvia.io/v1alpha1\nkind: Policy\nmetadata:\n  name: environment-defaults\nspec:\n  defaults:\n    # Can be used to filter on configuration module sources\n    modules:\n      - <REGEX>\n    namespace:\n      # Match on namespace labels\n      matchLabels:\n        kubernetes.io/metadata.name: hello\n      # Use expressions to match on namespace labels\n      matchExpressions:\n        - key: kubernetes.io/metadata.name\n          operator: Exists\n    variables:\n      environment: dev\n")))}m.isMDXComponent=!0}}]);