"use strict";(self.webpackChunkterranetes=self.webpackChunkterranetes||[]).push([[501],{6120:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var t=r(4848),o=r(8453);const a={sidebar_position:3,sidebar_class_name:"green"},i="Contexts",s={id:"admin/contexts",title:"Contexts",description:"Contexts provide a means to share common configuration between Configurations. The resource type is Cluster scoped and can be used by any Configuration in the cluster.",source:"@site/docs/terranetes-controller/admin/contexts.md",sourceDirName:"admin",slug:"/admin/contexts",permalink:"/terranetes-controller/admin/contexts",draft:!1,unlisted:!1,editUrl:"https://github.com/appvia/terranetes/tree/master/docs/terranetes-controller/admin/contexts.md",tags:[],version:"current",lastUpdatedBy:"Kashif Saadat",lastUpdatedAt:172356685e4,sidebarPosition:3,frontMatter:{sidebar_position:3,sidebar_class_name:"green"},sidebar:"tutorialSidebar",previous:{title:"Checkov Policy",permalink:"/terranetes-controller/admin/policy/checkov"},next:{title:"Cloud Resources",permalink:"/terranetes-controller/admin/cloudresource"}},c={},l=[{value:"Create a Context",id:"create-a-context",level:2},{value:"Configure Preloading",id:"configure-preloading",level:2},{value:"How to reference a Context",id:"how-to-reference-a-context",level:2},{value:"Using a Custom Preload",id:"using-a-custom-preload",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"contexts",children:"Contexts"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Contexts"})," provide a means to share common configuration between ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/configurations.terraform.appvia.io",children:"Configurations"}),". The resource type is Cluster scoped and can be used by any Configuration in the cluster."]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsx)(n.p,{children:"This feature is only available from v0.3.25 onwards"})}),"\n",(0,t.jsx)(n.h2,{id:"create-a-context",children:"Create a Context"}),"\n",(0,t.jsxs)(n.p,{children:["You can create a ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"})," like so."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: terraform.appvia.io/v1alpha1\nkind: Context\nmetadata:\n  name: default\nspec:\n  #\n  ## All variables MUST follow the pattern of 'description' and 'value'. The\n  ## value can be any complex or simple type (boolean, int, map, object etc)\n  #\n  variables:\n    # Is the name of the variable\n    vpc_id:\n      # Provides a description to the consumer of the input\n      description: Is the network identifier we are residing\n      # The value of the value\n      value: vpc-1223133113\n    public_subnets_ids:\n      # Provides a description to the consumer of the input\n      description: |\n        Is a collection of subnet id's which are publicly available i.e.\n        they are attached to an internet gateway\n      # The value of the value\n      value:\n        - subnet-12312312312\n        - subnet-32332321312\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The resource contains a map of variables; note each variable MUST have a ",(0,t.jsx)(n.code,{children:"description"})," and ",(0,t.jsx)(n.code,{children:"value"}),", with the value being any simple (integer, boolean, string) or complex type (maps, list, maps or maps and so forth)."]}),"\n",(0,t.jsx)(n.h2,{id:"configure-preloading",children:"Configure Preloading"}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["Currently the cloud which has support for automatic preloading is ",(0,t.jsx)(n.strong,{children:"AWS"}),". Other providers are on the roadmap, but they have not been implemented yet."]})}),"\n",(0,t.jsxs)(n.p,{children:["Terranetes has the ability to populate a ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"})," automatically; retrieving details about the cluster the controller resides and populating them into a ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"}),". Currently this feature is limited to AWS only."]}),"\n",(0,t.jsxs)(n.p,{children:["In order to use the feature we need to update the configuration of a ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/providers.terraform.appvia.io",children:"Provider"}),"; It is the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/providers.terraform.appvia.io",children:"Providers"})," credentials which the preloading will use to retrieve the information from the cloud vendor."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"---\napiVersion: terraform.appvia.io/v1alpha1\nkind: Provider\nmetadata:\n  name: aws\nspec:\n  # Source and be 'secret' or 'injected'. When using a 'secret' you\n  # must specify the spec.secretRef which defines the name of the\n  # secret in the controller namespace containing the credentials.\n  source: secret\n  # Provider can be google, aws, azurerm, alicloud, azurestack, googleworkspace etc\n  provider: aws\n  # Provides configuration for the contextual data preloader (currently only\n  # available for aws)\n  preload:\n    # Indicates if the preloading should be enabled\n    enabled: true\n    # Is the EKS cluster we use to pivot network and settings around\n    cluster: eks\n    # Is the cloud region the cluster above resides\n    region: eu-west-2\n    # Is the terranetes context resource we should provision\n    context: default\n  # Used when spec.source is secret.\n  secretRef:\n    namespace: terraform-system\n    name: aws\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"spec.preload"})," in the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/providers.terraform.appvia.io",children:"Provider"})," needs the following information."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"enabled"})," Indicates if we should preload any data into a ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cluster"})," Is the cloud name of the cluster we reside in i.e. the EKS cluster name."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"region"})," Is the cloud region the cluster (",(0,t.jsx)(n.code,{children:"spec.preload.cluster"}),") resides in."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"context"})," Is the name of the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"})," you wish to populate the values into."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Once this information has been defined, a ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"})," resource be automatically provisioned and preloaded with details, as such;"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"$ k get contexts.terraform.appvia.io default  -o yaml\napiVersion: terraform.appvia.io/v1alpha1\nkind: Context\nmetadata:\n  generation: 1\n  labels:\n    terranetes.appvia.io/preload-provider-name: aws\n  name: default\nspec:\n  variables:\n    eks:\n      description: AWS ARN for the Kubernetes cluster\n      value: arn:aws:eks:eu-west-2:XXXXXXXXX:cluster/eks-test\n    eks_cluster_security_group_id:\n      description: The security group ID attached to the EKS cluster\n      value: sg-XXXXXXXXX\n    eks_endpoint:\n      description: The endpoint for the EKS cluster\n      value: https://XXXXXXXXXXXXXXXX.sk1.eu-west-2.eks.amazonaws.com\n    eks_name:\n      description: The name of the EKS cluster\n      value: eks\n    eks_platform_version:\n      description: The platform version of the EKS cluster\n      value: eks.6\n    eks_private_access:\n      description: Indicates whether or not the EKS cluster has private access enabled\n      value: true\n    eks_public_access:\n      description: Indicates whether or not the EKS cluster has public access enabled\n      value: false\n    eks_public_access_cidrs:\n      description: The CIDR blocks that are allowed access to the EKS cluster\n      value:\n      - 0.0.0.0/0\n    eks_role_arn:\n      description: The ARN of the IAM role that provides permissions for the EKS cluster\n      value: arn:aws:iam::XXXXXXXXXX:role/eks-test-role\n    eks_route_tables_ids:\n      description: A list of all route tables id associate to the subnets which are\n        part of the EKS cluster\n      value:\n      - rtb-04dbff51b83821XXX\n     ....MORE VARIABLES\n    vpc_id:\n      description: The ID of the VPC used by the EKS cluster\n      value: vpc-0a6f4fbb4bXXXXXXX\n"})}),"\n",(0,t.jsx)(n.h2,{id:"how-to-reference-a-context",children:"How to reference a Context"}),"\n",(0,t.jsxs)(n.p,{children:["Contexts can be referenced from any ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/configurations.terraform.appvia.io",children:"Configuration"})," like so"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"  ---\n  apiVersion: terraform.appvia.io/v1alpha1\n  kind: Configuration\n  metadata:\n    name: bucket\n  spec:\n    module: https://github.com/terraform-aws-modules/terraform-aws-s3-bucket.git?ref=v3.10.1\n    providerRef:\n      name: aws\n    valueFrom:\n      - context: default\n        key: vpc_id\n        name: vpc_id\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"spec.valueFrom"})," requires the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"})," name, the key is the name of the variable in the context and the name is the variable you need to present this as to the terraform module. The optional field simply means both the context and any value reference, if they don't exist, can continue without failure. By default, anything missing (context or value) will defer the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/configurations.terraform.appvia.io",children:"Configuration"})," until they are present."]}),"\n",(0,t.jsx)(n.h2,{id:"using-a-custom-preload",children:"Using a Custom Preload"}),"\n",(0,t.jsx)(n.p,{children:"Terranetes comes prebuilt with a loader to extract details from the cloud vendor, but perhaps it doesn't contain the details you need. You can solve this in two ways"}),"\n",(0,t.jsxs)(n.p,{children:["a) Configuration can reference multiple ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"})," resources, so you can provision with additional details / values.\nb) Override the preload image in the controller and run your own custom loader."]}),"\n",(0,t.jsxs)(n.p,{children:["The first one is simple and can achieved in multiple ways; manually, ci, helm and so forth. The second option, overloading the controller's preload images requires you update the ",(0,t.jsx)(n.code,{children:"--preload-image"})," argument. In the helm chart, this can be done via"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"controller:\n  images:\n    preload: IMAGE:TAG\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Note, the entrypoint when using this image is currently hardcoded, so you have to ensure in the image we have an executable at ",(0,t.jsx)(n.code,{children:"/bin/preload"}),". The following arguments will also be passed, via environment variables to the execution"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"CLOUD"})," is the cloud vendor designation from the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/providers.terraform.appvia.io",children:"Provider"})," the preload is configured on i.e. ",(0,t.jsx)(n.code,{children:"spec.provider"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"CLUSTER"})," is the cluster name from the preload configuration i.e ",(0,t.jsx)(n.code,{children:"spec.preload.cluster"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"CONTEXT"})," is the name of the context (",(0,t.jsx)(n.code,{children:"spec.preload.context"}),") defined in the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/providers.terraform.appvia.io",children:"Provider"})," configuration."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"PROVIDER"})," is the name of the provider the preload was configured on ",(0,t.jsx)(n.code,{children:"metadata.name"})," on the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/providers.terraform.appvia.io",children:"Provider"})," resource."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"REGION"})," is the cloud region configured in the ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/providers.terraform.appvia.io",children:"Provider"})," preload configuration i.e ",(0,t.jsx)(n.code,{children:"spec.preload.region"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"When using a custom loader the executable is responsible for two things"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Retrieving the cloud details and constructing a valid ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/contexts.terraform.appvia.io",children:"Context"})," resource."]}),"\n",(0,t.jsxs)(n.li,{children:["Creating or updating the ",(0,t.jsx)(n.code,{children:"CONTEXT"})," in the Kubernetes cluster itself."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The controller is responsible for ensuring execution occurs, handing jobs fails and configuring the job with ",(0,t.jsx)(n.a,{href:"/terranetes-controller/reference/providers.terraform.appvia.io",children:"Provider"})," credentials."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>s});var t=r(6540);const o={},a=t.createContext(o);function i(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);